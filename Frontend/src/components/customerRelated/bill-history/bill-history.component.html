<nav class="wm-navbar">
  <div class="wm-container">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- simple bolt icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="bolt">
          <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
       <a href="/"><span class="brand-name">PowerEase</span></a>
    </div>

    <ul class="nav-links">
      <li><a href="/customer/home" style="color: #0EA5A4;">Home</a></li>
      <li><a href="/customer/view-bill">View Bill</a></li>
      <li><a href="/customer/complaint-status">Search Complaint</a></li>
      <li><a href="/customer/register-complaint" style="color:red">Register Complaint</a></li>
    </ul>
  </div>
</nav>

<div class="bh-root container">
  <h2 class="heading">Electricity Usage & Bill History</h2>

  <!-- Authentication / Error -->
  <div *ngIf="error && !loading" class="card error-card">
    <p class="mb-2">{{ error }}</p>
    <div class="actions">
      <button class="btn btn-outline-secondary" (click)="goBack()">Back</button>
      <button class="btn btn-primary" (click)="retry()">Retry</button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner" aria-hidden="true"></div>
    <div>Loading bill history...</div>
  </div>

  <!-- Main content -->
  <div *ngIf="!loading && !error" class="card content-card">
    <!-- Controls: date range and filters -->
    <div class="controls d-flex flex-wrap gap-2 align-items-end">
      <div class="control">
        <label class="form-label small">From</label>
        <input type="date" class="form-control" [(ngModel)]="fromDate" (change)="onFilterChange()" />
      </div>

      <div class="control">
        <label class="form-label small">To</label>
        <input type="date" class="form-control" [(ngModel)]="toDate" (change)="onFilterChange()" />
      </div>

      <div class="control">
        <label class="form-label small">Payment Status</label>
        <select class="form-select" [(ngModel)]="statusFilter" (change)="onFilterChange()">
          <option value="ALL">All</option>
          <option value="PAID">Paid</option>
          <option value="UNPAID">Unpaid</option>
          <option value="PARTIAL">Partial</option>
        </select>
      </div>

      <div class="control ms-auto">
        <label class="form-label small">Visible Total</label>
        <div class="visible-total">₹ {{ formatCurrency(visibleTotal) }}</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive mt-3">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Bill Number</th>
            <th (click)="toggleSort('billDate')" class="sortable">
              Bill Date
              <small *ngIf="sortColumn === 'billDate'">({{ sortDirection }})</small>
            </th>
            <th>Billing Period</th>
            <th (click)="toggleSort('dueDate')" class="sortable">
              Due Date
              <small *ngIf="sortColumn === 'dueDate'">({{ sortDirection }})</small>
            </th>
            <th (click)="toggleSort('billAmount')" class="text-end sortable">
              Bill Amount
              <small *ngIf="sortColumn === 'billAmount'">({{ sortDirection }})</small>
            </th>
            <th>Payment Status</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let b of filtered">
            <td>{{ b.id }}</td>
            <td>{{ b.billDate }}</td>
            <td>{{ b.billingPeriod }}</td>
            <td>{{ b.dueDate }}</td>
            <td class="text-end">₹ {{ formatCurrency(b.billAmount) }}</td>
            <td>
              <span class="status" [ngClass]="{
                'paid': b.paymentStatus === 'PAID',
                'unpaid': b.paymentStatus === 'UNPAID',
                'partial': b.paymentStatus === 'PARTIAL'
              }">{{ b.paymentStatus }}</span>
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary" (click)="printBillAsPDF(b)" title="Download Bill as PDF">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; margin-right: 4px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Print PDF
              </button>
            </td>
          </tr>

          <tr *ngIf="!filtered || filtered.length === 0">
            <td colspan="9" class="text-center p-4">
              No billing records found for the selected range / filters.
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary" (click)="loadBills()">Reset & Refresh</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
