<nav class="wm-navbar">
  <div class="wm-container">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="bolt">
          <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"
                stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <a href="/"><span class="brand-name">PowerEase</span></a>
    </div>

    <ul class="nav-links">
      <li><a href="/" style="color: #0ea5a4">Home</a></li>
      <li><a href="/login" class="cta">Login</a></li>
    </ul>
  </div>
</nav>

<div class="register-wrapper d-flex justify-content-center align-items-center">
  <div class="register-card shadow-lg p-4" style="width:700px;">

    <div class="text-center mb-4">
      <svg viewBox="0 0 24 24" class="bolt-icon" fill="none" stroke="currentColor">
        <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"
              stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <h3 class="fw-bold text-dark mb-1">Customer Registration</h3>
    </div>

    <!-- Template-driven form reference -->
    <form #regForm="ngForm" (ngSubmit)="registerUser(regForm)" class="p-4" novalidate>

      <!-- Consumer Number -->
      <div class="form-group mb-3">
        <label>Consumer Number</label>
        <input
          type="text"
          class="form-control"
          name="consumerNumber"
          required
          pattern="^[1-9][0-9][0-9]{11}$"
          maxlength="13"
          minlength="13"
          [(ngModel)]="user.consumerNumber"
          (change)="fetchUserDetails()"
          placeholder="Enter Consumer Number" >
        <div *ngIf="(regForm.submitted || regForm.controls['consumerNumber']?.touched) && regForm.controls['consumerNumber']?.errors" class="text-danger small">
          <div *ngIf="regForm.controls['consumerNumber']?.errors?.['required']">Consumer number is required.</div>
          <div *ngIf="regForm.controls['consumerNumber']?.errors?.['pattern']">Please enter correct consumer number</div>
        </div>
        <div *ngIf="isRegistered" class="text-danger small">Already registered. Proceed to <a href="/login">Login</a></div>
      </div>

      <!-- Full Name -->
      <div class="form-group mb-3">
        <label>Full Name</label>
        <input type="text" class="form-control" [(ngModel)]="user.fullName" name="fullName" disabled>
      </div>

      <!-- Email -->
      <div class="form-group mb-3">
        <label>Email</label>
        <input type="email" class="form-control" [(ngModel)]="user.email" name="email" disabled>
      </div>

      <!-- Phone -->
      <div class="form-group mb-3">
        <label>Phone Number</label>
        <input type="text" class="form-control" [(ngModel)]="user.mobile" name="mobile" disabled>
      </div>

      <!-- Connection Type -->
      <div class="form-group mb-3">
        <label>Connection Type</label>
        <select class="form-control" [(ngModel)]="user.customerType" name="customerType" disabled>
          <option value="">Choose Type</option>
          <option value="Residential">Residential</option>
          <option value="Commercial">Commercial</option>
        </select>
      </div>

      <!-- Ward -->
      <div class="form-group mb-3">
        <label>Region Ward</label>
        <select class="form-control" [(ngModel)]="user.electricalSection" name="electricalSection" disabled>
          <option value="">Choose Ward</option>
          <option value="Ward A">Ward A</option>
          <option value="Ward B">Ward B</option>
          <option value="Ward C">Ward C</option>
        </select>
      </div>

      <!-- PINCODE -->
      <div class="form-group mb-3">
        <label>Pincode</label>
        <input type="text" class="form-control" [(ngModel)]="user.pincode" name="pincode" disabled>
      </div>

      <!-- CITY -->
      <div class="form-group mb-3">
        <label>City</label>
        <input type="text" class="form-control" [(ngModel)]="user.city" name="city" disabled>
      </div>

      <!-- STATE -->
      <div class="form-group mb-3">
        <label>State</label>
        <input type="text" class="form-control" [(ngModel)]="user.state" name="state" disabled>
      </div>

      <!-- ADDRESS -->
      <div class="form-group mb-3">
        <label>Address</label>
        <textarea class="form-control" [(ngModel)]="user.address" name="address" disabled></textarea>
      </div>

      <!-- FIRST LOGIN PASSWORD -->
      <div class="form-group mb-3 d-flex align-items-center">
        <div style="flex:1">
          <label>Enter First Login Password</label>
          <input type="password" class="form-control"
                 [(ngModel)]="firstPassword" name="firstPassword" [disabled]="isRegistered">
        </div>

        <div class="ms-3 mt-4">
          <button type="button"
                  class="btn btn-outline-secondary"
                  (click)="verifyPass()"
                  [disabled]="isRegistered || !user.consumerNumber">
            Verify
          </button>
        </div>
      </div>

      <!-- NEW PASSWORD -->
      <div class="form-group mb-3">
        <label>Create Password <small *ngIf="!isPasswordVerified" class="text-muted">(verify to enable)</small></label>
        <input
          type="password"
          class="form-control"
          name="newPassword"
          [(ngModel)]="user.newPassword"
          minlength="8"
          required
          [disabled]="!isPasswordVerified">
        <div *ngIf="(regForm.submitted || regForm.controls['newPassword']?.touched) && regForm.controls['newPassword']?.errors" class="text-danger small">
          <div *ngIf="regForm.controls['newPassword']?.errors?.['required']">Password is required.</div>
          <div *ngIf="regForm.controls['newPassword']?.errors?.['minlength']">Minimum 8 characters required.</div>
        </div>
      </div>

      <!-- CONFIRM PASSWORD -->
      <div class="form-group mb-3">
        <label>Confirm Password</label>
        <input
          type="password"
          class="form-control"
          name="confirmPassword"
          [(ngModel)]="user.confirmPassword"
          minlength="8"
          required
          [disabled]="!isPasswordVerified">
        <div *ngIf="(regForm.submitted || regForm.controls['confirmPassword']?.touched)" class="text-danger small">
          <div *ngIf="regForm.controls['confirmPassword']?.errors?.['required']">Confirm password is required.</div>
          <div *ngIf="user.newPassword && user.confirmPassword && !passwordsMatch()">Passwords do not match.</div>
        </div>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <span class="text-danger">{{ errorMessage }}</span>
        <!-- Register disabled if not verified OR no passwords OR mismatch OR form invalid OR loading -->
        <button
          class="btn btn-primary"
          type="submit"
          [disabled]="isLoading || !isPasswordVerified || !passwordsMatch() || !(regForm.form?.valid)">
          {{ isLoading ? 'Registering...' : 'Register' }}
        </button>
      </div>

    </form>
  </div>
</div>

<!-- SUCCESS MODAL -->
<div class="custom-modal-backdrop" *ngIf="showUserIdModal">
  <div class="custom-modal">
    <h4 style="color:green">Registration Success!</h4>
    <p><b>{{ user.userId }}</b></p>

    <button class="btn btn-success btn-sm" (click)="copyUserId()">Copy</button>
    <a href="/login" class="btn btn-info btn-sm mx-2">Proceed to Login</a>&nbsp;
    <a href="" class="btn btn-outline-warning btn-sm mx-2">Not now?</a>
  </div>
</div>

<!-- ERROR MODAL -->
<div class="custom-modal-backdrop" *ngIf="showErrorIdModal">
  <div class="custom-modal">
    <h4 style="color:red">Registration Failed</h4>
    <p><b>Duplicate entry or invalid data!</b></p>
    <button class="btn btn-danger btn-sm" (click)="registerAgain()">Try Again</button>
  </div>
</div>
